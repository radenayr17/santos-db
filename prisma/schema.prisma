// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("AURORA_DATABASE_URL")
}

model User {
  uuid                 String    @id @default(uuid())
  email                String    @unique
  cognitoId            String    @unique
  firstName            String
  lastName             String
  username             String    @unique
  department           String?
  isActive             Boolean   @default(true)
  phoneNumber          String?
  commentNotifications Boolean   @default(true)
  emailNotifications   Boolean   @default(true)
  notifSettings        Json?     @default("{}")
  isDeleted            Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deletedAt            DateTime?
  lastLogin            DateTime?
  firstLogin           DateTime?

  supplier                Supplier?                @relation(fields: [supplierUuid], references: [uuid])
  role                    Role                     @relation(fields: [roleUuid], references: [uuid])
  roleUuid                String
  supplierUuid            String?
  userGotNotification     UserGotNotification[]
  comment                 Comment[]
  POADocument             POADocument[]
  tableViewSettings       TableSettings[]
  POAuditLog              POAuditLog[]
  Invoice                 Invoice[]
  Approver                Invoice[]                @relation("approver")
  emailWhitelistAuditLogs EmailWhitelistAuditLog[]
  AuditLog                AuditLog[]
  CreatedPOR              PORequest[]              @relation("createdBy")
  UpdatedPOR              PORequest[]              @relation("updatedBy")
  PCRHistory              PCRHistory[]
}

model Role {
  uuid       String @id @default(uuid())
  name       String @unique
  privileges Json
  type       String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User[]
}

model Supplier {
  uuid                String               @id @default(uuid())
  name                String
  tradingName         String?
  accountNumber       String               @unique
  ABN                 String?
  streetAddress       String?
  suburb              String?
  city                String?
  state               String?
  postCode            String?
  countryCode         String?
  country             String?
  postingBlockStatus  Boolean
  paymentBlockStatus  Boolean
  isActive            Boolean
  ACN                 String?
  paymentTerms        String?
  POEmail             String?
  remittanceEmail     String?
  generalEmail        String?
  shipping            String?
  taxCountryRegion    String?
  companyCode         Json                 @default("[]")
  taxIdNo             String?
  configCreateInvoice ConfigCreateInvoice?
  configCreatePOR     ConfigCreateInvoice?
  ediIndicator        Boolean              @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplierAdresses SupplierAddress[]
  users            User[]
  bankingData      BankingData[]
  PODocument       PODocument[]
  POADocument      POADocument[]
  POVersions       POVersion[]
  AuditLog         AuditLog[]
  APMessage        APMessage[]
}

model SupplierAddress {
  uuid           String  @id @default(uuid())
  orderingSiteId String  @unique
  city           String
  state          String
  countryCode    String
  postCode       String
  streetAddress  String
  isActive       Boolean
  poEmail        String

  Supplier     Supplier? @relation(fields: [supplierUuid], references: [uuid])
  supplierUuid String?
}

model BankingData {
  uuid              String   @id @default(uuid())
  remitToCode       String
  BSB               String?
  accountNumber     String
  accountHolderName String
  validToDate       DateTime
  isActive          Boolean
  supplier          Supplier @relation(fields: [supplierUuid], references: [uuid])
  supplierUuid      String

  @@unique([remitToCode, supplierUuid])
}

model Comment {
  uuid        String  @id @default(uuid())
  authorUuid  String
  message     String
  visibility  String  @default("internal") //internal, external
  POUuid      String?
  revision    String? @default("")
  invoiceUuid String?

  author        User           @relation(fields: [authorUuid], references: [uuid])
  PODocument    PODocument?    @relation(fields: [POUuid], references: [uuid])
  notifications Notification[]
  attachments   Attachment[]
  invoice       Invoice?       @relation(fields: [invoiceUuid], references: [uuid])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Attachment {
  uuid        String @id @default(uuid())
  commentUuid String
  fileName    String

  Comment Comment @relation(fields: [commentUuid], references: [uuid])
}

model Notification {
  uuid           String  @id @default(uuid())
  message        String?
  category       String
  type           String
  PODocumentUuid String?
  commentUuid    String?
  fileUuid       String?
  invoiceUuid    String?

  comment             Comment?              @relation(fields: [commentUuid], references: [uuid])
  PODocument          PODocument?           @relation(fields: [PODocumentUuid], references: [uuid])
  POFile              POFile?               @relation(fields: [fileUuid], references: [uuid])
  UserGotNotification UserGotNotification[]
  invoice             Invoice?              @relation(fields: [invoiceUuid], references: [uuid])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserGotNotification {
  uuid             String   @id @default(uuid())
  read             Boolean
  notificationUuid String
  userUuid         String
  tagged           Boolean?
  removed          Boolean  @default(false) //if user removed notification

  notification Notification @relation(fields: [notificationUuid], references: [uuid])
  user         User         @relation(fields: [userUuid], references: [uuid])
  readAt       DateTime?
}

model PODocument {
  uuid               String    @id @default(uuid())
  orderType          String //GoodsOrder or ServicesOrder
  purchasingEntity   String
  purchasingPlant    String
  supplierShipTo     String
  pickUpInformation  String
  billToName         String
  billToEmail        String
  orderNo            String    @unique
  revision           String
  PODate             DateTime
  revisionDate       DateTime?
  currency           String
  procurementContact String
  procurementDetail  Json?
  requester          String
  agreementNo        String
  paymentTerms       String?
  incoterms          String
  additionalInfo     String?
  totalExcludeTax    Decimal
  //totalIncludedTax   Decimal
  //totalTax           Decimal
  supplierAccountNo  String?
  status             String?   @default("Unacknowledged") //Unacknowledged, Acknowledged, Rejected, Completed
  reminder           Boolean   @default(false)
  executionArn       String?
  pfsTick            Boolean   @default(false)
  companyCode        String?
  supplierReference  String?
  deleteCode         String? //DELETED, LOCKED
  ediUploadStatus    String?   @default("")
  ediUploadResponse  String?   @default("")

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  supplier      Supplier?      @relation(fields: [supplierAccountNo], references: [accountNumber])
  POItems       POItem[]
  comments      Comment[]
  notifications Notification[]
  POADocument   POADocument[]
  POAuditLog    POAuditLog[]
  POFile        POFile[]
  POVersions    POVersion[]
  Invoices      Invoice[]
  PORequest     PORequest[]
}

model POItem {
  uuid                    String   @id @default(uuid())
  itemNo                  Int
  materialNumber          String
  description             String?
  supplierReference       String?
  manufacturersPartNumber String?
  costElements            Json //Array of decimal numbers or strings
  quantity                Int
  unit                    String
  unitPrice               Decimal
  discount                Decimal
  extendedPrice           Decimal?
  finalDestination        String
  supplierDueDate         DateTime
  requisition             Int?
  freight                 Decimal? @db.Decimal(10, 4)
  deleteCode              String? //DELETED, LOCKED

  PODocumentUuid String
  PODocument     PODocument    @relation(fields: [PODocumentUuid], references: [uuid])
  InvoiceLine    InvoiceLine[]

  parentPoItemUuid String?
  parentPoItem     POItem?   @relation("ParentChild", fields: [parentPoItemUuid], references: [uuid])
  poItems          POItem[]  @relation("ParentChild")
  PORItem          PORItem[]
}

model POADocument {
  uuid              String   @id @default(uuid())
  orderNo           String
  revision          String
  acknowledgeDate   DateTime
  supplierAccountNo String?
  poDocumentUuid    String?
  rejectReason      String?
  userUuid          String?
  status            String   @default("active") //active, inactive, rejected
  csvResult         String?  @default("")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  PODocument PODocument? @relation(fields: [poDocumentUuid], references: [uuid])
  user       User?       @relation(fields: [userUuid], references: [uuid])
  supplier   Supplier?   @relation(fields: [supplierAccountNo], references: [accountNumber])
  poaItems   POAItem[]
  POFile     POFile[]
}

model POAItem {
  uuid            String    @id @default(uuid())
  itemNo          Int
  supplierDueDate DateTime?
  quantity        Int
  unitPrice       Decimal
  unit            String
  changesReason   String

  POADocument     POADocument? @relation(fields: [pOADocumentUuid], references: [uuid], onDelete: Cascade)
  pOADocumentUuid String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  uuid                  String    @id @default(uuid())
  invoiceAPId           String    @unique
  invoiceNo             String
  type                  String    @default("invoice") //invoice or credit
  subtype               String?
  orderNo               String
  orgInvNo              String?
  orgInvDate            DateTime?
  settlementDate        DateTime?
  remitToCode           String    @default("")
  vendorNo              String?
  channel               String?
  submittedby           String?
  invoiceDate           DateTime?
  netTotal              Decimal
  totalTax              Decimal
  total                 Decimal
  currency              String
  taxCode               String
  freight               String?
  freightTax            String?
  freightCurrency       String?
  freightTaxCode        String?
  addCharges            Decimal?
  addChargesTax         Decimal?
  addChargesTaxCode     String?
  addChargesCurrency    String?
  whtAmount             Decimal?
  whtBase               Decimal?
  whtCountry            String?
  whtTaxType            String?
  whtTaxCode            String?
  whtTaxCodeDesc        String?
  sesProvided           Boolean?
  costProvided          Boolean?
  userUuid              String?
  companyCode           String?
  creditNoteNo          String    @default("")
  businessNo            String    @default("") //business number
  bsb                   String    @default("")
  acn                   String    @default("") //account number
  freightStatus         String    @default("PENDING") //PENDING, APPROVED, REJECTED
  freightUpdateAt       DateTime?
  freightApprovalReason String?   @default("")
  isDraft               Boolean   @default(false)
  //SAP CSV
  remitNo               String?
  remitDate             DateTime?
  remitStatus           String?
  remitAmount           Decimal?
  //IQX CSV
  rejectComment         String?
  sapBillingNo          String?
  iqxRequestNo          String?
  lastUpdateDate        DateTime?
  dueDate               DateTime?
  //NPS CSV
  supplierInvoiceNo     String?
  supplierId            String?
  amount                Decimal?
  plantId               String?
  plantDescription      String?
  submittedDate         DateTime?
  billingDocType        String?
  paymentTerms          String?   @default("")

  createdDate        DateTime       @default(now())
  createdFrom        String? // AP Portal, Supplier Platform
  receivedDate       DateTime?
  status             String
  unansweredComments Boolean?
  disputeReason      String?
  applicableWHT      Boolean?
  poUuid             String?
  updatedAt          DateTime       @updatedAt
  updatedByUuid      String?
  paymentDate        DateTime?
  exportedBy         String?
  exported           Boolean?       @default(false)
  meta               Json?          @default(dbgenerated())
  po                 PODocument?    @relation(fields: [poUuid], references: [uuid])
  approver           User?          @relation("approver", fields: [userUuid], references: [uuid])
  InvoiceLine        InvoiceLine[]
  comments           Comment[]
  Notification       Notification[]
  POAuditLog         POAuditLog[]
  updatedBy          User?          @relation(fields: [updatedByUuid], references: [uuid])
  InvoiceFile        InvoiceFile[]

  @@unique([invoiceNo, creditNoteNo])
}

model InvoiceLine {
  uuid                 String    @id @default(uuid())
  itemNo               String //itemNo poLineNo
  imrNo                String?
  description          String?
  taxCode              String?
  price                Decimal
  taxValue             Decimal
  supplierPartNumber   String?
  unit                 String? //uom
  netWeight            String?
  priceWeight          String?
  quantity             Decimal? //supQty
  totalGross           Decimal? //grossLineTotal
  total                Decimal? //total
  poLine               String?
  reviewReason         String?
  serviceTimeSheetLine String?
  POItemUuid           String?
  invoiceUuid          String?
  meta                 Json?     @default(dbgenerated())
  packQty              Decimal?
  ordQty               Decimal?
  expiryDate           DateTime?
  date                 DateTime?
  code                 String? //vendor code
  ean                  String? //barcode
  freightCondition     Decimal?  @db.Decimal(10, 4)
  buyersCode           String? //material
  esn                  String?
  resourceName         String?
  starting             String?
  finishing            String?
  glCode               String?
  wo                   String?
  woActivity           String?
  poLineDesc           String?
  network              String?
  networkActivity      String?
  wbs                  String?
  costCenter           String?
  poServiceLineNo      String?
  lineOrderReference   String?
  attr1                String?
  attr2                String?
  attr3                String?
  attr4                String?
  attr5                String?
  attr6                String?
  attr7                String?
  attr8                String?
  attr9                String?
  attr10               String?
  attr11               String?
  attr12               String?
  attr13               String?
  attr14               String?
  attr15               String?
  attr16               String?
  attr17               String?
  attr18               String?
  attr19               String?
  attr20               String?

  poItem  POItem?  @relation(fields: [POItemUuid], references: [uuid])
  invoice Invoice? @relation(fields: [invoiceUuid], references: [uuid])
}

model InvoiceFile {
  uuid     String @id @default(uuid())
  name     String
  mimeType String
  bucket   String
  key      String

  invoiceUuid String
  createdAt   DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceUuid], references: [uuid])
}

model Settings {
  uuid                              String   @id @default(uuid())
  senderEmail                       String   @default("")
  maxRetryCount                     Int      @default(3)
  techSupportEmails                 Json? //array of emails
  businessNotifications             Json? //Object {moduleName: array of emails}
  priceTolerance                    Decimal  @default(0)
  quantityTolerance                 Int      @default(0)
  defaultNotificationsLength        Int      @default(10)
  buyerApprovalReminderDays         Int      @default(0)
  suppliersCanCreateInvoiceInPortal Boolean  @default(false)
  suppliersCanCreatePORInPortal     Boolean  @default(true)
  masterVendorEmail                 String   @default("vendor.records@santos.com")
  exportPORetryCount                Int      @default(3)
  updatedAt                         DateTime @updatedAt
}

model TableSettings {
  uuid           String @id @default(uuid())
  name           String
  table          String
  viewSettings   Json
  filterSettings Json?

  user     User   @relation(fields: [userUuid], references: [uuid])
  userUuid String
}

model POAuditLog {
  uuid        String  @id @default(uuid())
  event       String //created, updated, viewed, acknowledged, poa_csv_upload, poa_csv_error
  data        Json?
  description String?
  userUuid    String?
  poUuid      String?
  revision    String?
  invoiceUuid String?

  user    User?       @relation(fields: [userUuid], references: [uuid])
  po      PODocument? @relation(fields: [poUuid], references: [uuid])
  invoice Invoice?    @relation(fields: [invoiceUuid], references: [uuid])

  createdAt DateTime @default(now())
}

model POFile {
  uuid     String  @id @default(uuid())
  file     String
  poUuid   String?
  revision String?
  type     String  @default("xml")
  poaUuid  String?

  createdAt DateTime @default(now())

  po           PODocument?    @relation(fields: [poUuid], references: [uuid])
  Notification Notification[]
  poa          POADocument?   @relation(fields: [poaUuid], references: [uuid])
}

model POVersion {
  uuid               String    @id @default(uuid())
  poUuid             String
  orderType          String //GoodsOrder or ServicesOrder
  purchasingEntity   String
  purchasingPlant    String
  supplierShipTo     String
  pickUpInformation  String
  billToName         String
  billToEmail        String
  orderNo            String
  revision           String
  PODate             DateTime
  revisionDate       DateTime?
  currency           String
  procurementContact String
  procurementDetail  Json?
  requester          String
  agreementNo        String
  paymentTerms       String?
  incoterms          String
  additionalInfo     String?
  totalExcludeTax    Decimal
  supplierAccountNo  String?
  pfsTick            Boolean   @default(false)
  companyCode        String?
  supplierReference  String?
  deleteCode         String? //DELETED, LOCKED
  ediUploadStatus    String?   @default("")
  ediUploadResponse  String?   @default("")

  createdAt DateTime @default(now())

  supplier Supplier?       @relation(fields: [supplierAccountNo], references: [accountNumber])
  po       PODocument?     @relation(fields: [poUuid], references: [uuid])
  POItems  POVersionItem[]
}

model POVersionItem {
  uuid                    String   @id @default(uuid())
  poVersionUuid           String
  itemNo                  Int
  materialNumber          String
  description             String?
  manufacturersPartNumber String?
  costElements            Json //Array of decimal numbers or strings
  quantity                Int
  unit                    String
  unitPrice               Decimal
  discount                Decimal
  extendedPrice           Decimal?
  finalDestination        String
  supplierDueDate         DateTime
  requisition             Int?
  freight                 Decimal? @db.Decimal(10, 4)
  supplierReference       String?
  deleteCode              String? //DELETED, LOCKED

  poVersion               POVersion       @relation(fields: [poVersionUuid], references: [uuid])
  parentPoVersionItemUuid String?
  parentPoVersionItem     POVersionItem?  @relation("ParentChild", fields: [parentPoVersionItemUuid], references: [uuid])
  poVersionItems          POVersionItem[] @relation("ParentChild")
}

model EmailWhitelist {
  uuid  String @id @default(uuid())
  email String @unique
}

model EmailWhitelistAuditLog {
  uuid      String   @id @default(uuid())
  event     String // "viewed" | "addition" | "modification" | "removal"
  userUuid  String
  email     String?
  user      User     @relation(fields: [userUuid], references: [uuid])
  createdAt DateTime @default(now())
}

model AuditLog {
  uuid         String   @id @default(uuid())
  model        String
  event        String
  description  String
  userUuid     String?
  supplierUuid String?
  createdAt    DateTime @default(now())

  user     User?     @relation(fields: [userUuid], references: [uuid])
  supplier Supplier? @relation(fields: [supplierUuid], references: [uuid])
}

model APMessage {
  uuid         String   @id @default(uuid())
  messageId    String   @unique
  status       String
  attachments  String
  subject      String
  sender       String
  code         String?
  account      String
  receivedDate DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplier Supplier? @relation(fields: [code], references: [accountNumber])
}

model PORequest {
  uuid         String  @id @default(uuid())
  revision     String
  changeId     String  @unique // to be used for change request to IQX API
  status       String  @default("PENDING")
  action       String
  iqxReqNo     String? // IQX request number
  reason       String? // for reject / withdrawn changes
  response     String  @default("PENDING") // PENDING, SUCCESS, FAILED
  responseFile String?
  pcrStatus    String  @default("")
  isWithdrawn  Boolean @default(false)

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lastUpdate DateTime?

  poUuid    String
  createdBy String
  updatedBy String?

  po            PODocument?  @relation(fields: [poUuid], references: [uuid])
  createdByUser User?        @relation("createdBy", fields: [createdBy], references: [uuid])
  updatedByUser User?        @relation("updatedBy", fields: [updatedBy], references: [uuid])
  PORItem       PORItem[]
  PCRHistory    PCRHistory[]
}

model PORItem {
  uuid              String   @id @default(uuid())
  price             Decimal  @db.Decimal(10, 4)
  quantity          Decimal  @db.Decimal(10, 4)
  deleted           Boolean  @default(false)
  deliveryCompleted Boolean? @default(false)
  description       String   @default("")
  itemNo            String   @default("")
  unit              String   @default("")

  dueDate   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  porUuid    String
  poItemUuid String?

  PORDocument PORequest? @relation(fields: [porUuid], references: [uuid], onDelete: Cascade)
  POItem      POItem?    @relation(fields: [poItemUuid], references: [uuid], onDelete: SetNull)
}

// model for PORequest history
model PCRHistory {
  uuid        String                 @id @default(uuid())
  description String
  filename    String
  action      PCRHistoryActionConfig

  createdAt DateTime @default(now())

  userUuid String?
  porUuid  String

  user User?      @relation(fields: [userUuid], references: [uuid])
  por  PORequest? @relation(fields: [porUuid], references: [uuid])
}

enum PCRHistoryActionConfig {
  Request
  Withdrawn
  Response
  ChangeStatus
}

enum ConfigCreateInvoice {
  DoNotOverride
  AllowToCreate
  DoNotAllowToCreate
}
